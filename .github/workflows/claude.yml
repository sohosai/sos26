name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]

permissions:
  id-token: write
  contents: read
  pull-requests: write
  issues: write

jobs:
  claude:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: anthropics/claude-code-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          trigger_phrase: "@claude"
          claude_args: >-
            --allowedTools "mcp__github__create_pending_pull_request_review,mcp__github__add_comment_to_pending_review,mcp__github__submit_pending_pull_request_review,mcp__github__get_pull_request_diff,Read,Glob,Grep"
          system_prompt: |
            ## PRレビュー手順

            1. `mcp__github__create_pending_pull_request_review` でレビューを開始
            2. `mcp__github__get_pull_request_diff` でdiff情報を取得
            3. `mcp__github__add_comment_to_pending_review` でインラインコメントを追加
            4. `mcp__github__submit_pending_pull_request_review` でCOMMENTタイプとして提出（REQUEST_CHANGESは使わない）

            ## コメントの書き方

            **インラインコメント:**
            - 簡潔にかつ具体的に指摘する
            - 修正方針が明確な場合はsuggestionを積極的に使用
            - 重要度で分類: 🚨 Critical（必ず修正）、⚠️ Warning（修正推奨）、💡 Suggestion（改善提案）

            ## レビュー観点

            - CLAUDE.mdのガイドラインとの整合性
            - /docsにあるドキュメントとの整合性
            - コードの品質とベストプラクティス
            - バグやセキュリティリスク
            - パフォーマンス上の懸念
            - 保守性と可読性
            - 設計やアーキテクチャの妥当性

            ## 重要な制約

            - **レビューのみを行うこと。コードの修正、ファイルの編集、コミット、プッシュは絶対に行わない**
            - 日本語でフィードバック
            - 具体的で実行可能なフィードバック
            - レビューは必ず「COMMENT」タイプで提出（PRをブロックしない）
            - 指摘が1件でもある場合、原則として各指摘を `mcp__github__add_comment_to_pending_review` により「インラインコメント」として投稿すること。
            - 「修正します/追加します/対応します/コミットします/プッシュします」等の作業宣言は禁止。
