generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator markdown {
  provider = "prisma-markdown"
  output   = "./ERD.md"
  title    = "ER図"
}

// ─────────────────────────────────────────────────────────────
// 認証: メール検証チャレンジ（一時）
// ─────────────────────────────────────────────────────────────

model EmailVerification {
  email     String   @id
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([expiresAt])
}

// ─────────────────────────────────────────────────────────────
// 認証: 短命チケット（Cookie の Opaque token に対応）
// ─────────────────────────────────────────────────────────────

model RegTicket {
  id        String   @id @default(cuid())
  tokenHash String   @unique
  email     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([expiresAt])
}

// ─────────────────────────────────────────────────────────────
// ユーザー
// ─────────────────────────────────────────────────────────────

model User {
  id              String    @id @default(cuid())
  firebaseUid     String
  email           String    @unique
  name            String
  namePhonetic    String
  telephoneNumber String
  deletedAt       DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // 企画関連
  ownedProjects    Project[]       @relation("ProjectOwner")
  subOwnedProjects Project[]       @relation("ProjectSubOwner")
  projectMembers   ProjectMember[]

  // 実委人関連
  committeeMember CommitteeMember?

  //Notice関連
  notices                       Notice[]              @relation("NoticeOwner")
  sharedNotices                 NoticeShare[]
  requestedNoticeAuthorizations NoticeAuthorization[] @relation("NoticeRequestedBy")
  receivedNoticeAuthorizations  NoticeAuthorization[] @relation("NoticeRequestedTo")

  userPushSubscriptions UserPushSubscription[]

  @@unique([firebaseUid, deletedAt])
  @@unique([email, deletedAt])
}

enum ProjectType {
  //ステージ企画
  STAGE

  //食品企画
  FOOD

  //普通企画
  NORMAL
}

model Project {
  id String @id @default(cuid())

  //企画名
  name         String @unique
  namePhonetic String

  //企画団体名
  organizationName         String
  organizationNamePhonetic String

  //企画区分
  type ProjectType

  //責任者
  ownerId String
  owner   User   @relation("ProjectOwner", fields: [ownerId], references: [id])

  //副責任者
  subOwnerId String?
  subOwner   User?   @relation("ProjectSubOwner", fields: [subOwnerId], references: [id])

  //招待コード
  inviteCode String @unique @db.Char(6)

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  projectMembers   ProjectMember[]
  noticeDeliveries NoticeDelivery[]

  @@index([ownerId])
  @@index([subOwnerId])
  @@index([deletedAt])
}

//プロジェクトに参加している責任者と副責任者以外のユーザーのTable
model ProjectMember {
  id        String @id @default(cuid())
  projectId String
  userId    String

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id])

  joinedAt  DateTime  @default(now())
  deletedAt DateTime?

  @@unique([projectId, userId, deletedAt])
  @@index([projectId])
  @@index([userId])
}

enum Bureau {
  FINANCE // 財務局 (zai)
  GENERAL_AFFAIRS // 総務局 (som)
  PUBLIC_RELATIONS // 広報宣伝局 (kosen)
  EXTERNAL // 渉外局 (sg)
  PROMOTION // 推進局 (ss)
  PLANNING // 総合計画局 (sok)
  STAGE_MANAGEMENT // ステージ管理局 (stage)
  HQ_PLANNING // 本部企画局 (honki)
  INFO_SYSTEM // 情報メディアシステム局 (jsys)
  INFORMATION // 案内所運営部会 (au)
}

//実委人の管理用Table
model CommitteeMember {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  //委員長
  isExecutive Boolean @default(false)

  //所属局
  Bureau Bureau

  joinedAt  DateTime  @default(now())
  deletedAt DateTime?

  permissions CommitteeMemberPermission[]
}

enum CommitteePermission {
  MEMBER_EDIT // メンバー編集
  NOTICE_DELIVER // お知らせ配信
  FORM_DELIVER // フォーム配信
}

//実委人の権限管理Table
model CommitteeMemberPermission {
  id String @id @default(cuid())

  committeeMemberId String
  permission        CommitteePermission

  committeeMember CommitteeMember @relation(fields: [committeeMemberId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([committeeMemberId, permission])
}

// ─────────────────────────────────────────────────────────────
// Push通知
// ─────────────────────────────────────────────────────────────

model PushSubscription {
  id        String    @id @default(cuid())
  endpoint  String    @unique
  p256dh    String
  auth      String
  deletedAt DateTime?
  expiresAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  users UserPushSubscription[]
}

// ─────────────────────────────────────────────────────────────
// User と PushSubscription の中間テーブル
// ─────────────────────────────────────────────────────────────

model UserPushSubscription {
  id                 String @id @default(cuid())
  userId             String
  pushSubscriptionId String

  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  pushSubscription PushSubscription @relation(fields: [pushSubscriptionId], references: [id], onDelete: Cascade)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  @@unique([userId, pushSubscriptionId])
  @@index([userId])
}

// ─────────────────────────────────────────────────────────────
// お知らせ関連
// ─────────────────────────────────────────────────────────────
//お知らせの作成
model Notice {
  id String @id @default(cuid())

  //お知らせの作成者
  ownerId String
  owner   User   @relation("NoticeOwner", fields: [ownerId], references: [id])

  // 共有ユーザー
  sharedUsers NoticeShare[]

  //配信許可など
  authorizations  NoticeAuthorization[]

  //タイトル
  title String @default("無題のお知らせ")

  //本文
  body String?

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

//お知らせの共有
model NoticeShare {
  id String @id @default(cuid())

  noticeId String
  userId   String

  notice Notice @relation(fields: [noticeId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id])

  //編集権限を持つのか
  isWrite Boolean @default(false)

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([noticeId, userId])
}

//Noticeに関する承認待ちの状態Enum
enum NoticeAuthorizationStatus {
  //承認待ち
  PENDING
  //承認済み(時間になれば配信される)
  APPROVED
  //承認されず
  REJECTED
}

//Noticeの配信許可
model NoticeAuthorization {
  id String @id @default(cuid())

  noticeId String
  notice   Notice @relation(fields: [noticeId], references: [id], onDelete: Cascade)

  //承認を求めた人
  requestedById String
  requestedBy   User   @relation("NoticeRequestedBy", fields: [requestedById], references: [id])

  //承認を求められた人
  requestedToId String
  requestedTo   User   @relation("NoticeRequestedTo", fields: [requestedToId], references: [id])

  //審査のステータス
  status NoticeAuthorizationStatus @default(PENDING)

  //審査を行った日付
  decidedAt DateTime?

  //配信したい日時
  //承認を求める側があらかじめここを埋める
  deliveredAt DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  deliveries NoticeDelivery[]
}

//Noticeの配信
model NoticeDelivery {
  id String @id @default(cuid())

  noticeAuthorizationId String
  projectId             String

  noticeAuthorization NoticeAuthorization @relation(fields: [noticeAuthorizationId], references: [id], onDelete: Cascade)

  //配信先の企画
  project Project @relation(fields: [projectId], references: [id])

  createdAt DateTime @default(now())

  @@unique([noticeAuthorizationId, projectId])
}
