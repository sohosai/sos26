generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator markdown {
  provider = "prisma-markdown"
  output   = "./ERD.md"
  title    = "ER図"
}

// ─────────────────────────────────────────────────────────────
// 認証: メール検証チャレンジ（一時）
// ─────────────────────────────────────────────────────────────

model EmailVerification {
  email     String   @id
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([expiresAt])
}

// ─────────────────────────────────────────────────────────────
// 認証: 短命チケット（Cookie の Opaque token に対応）
// ─────────────────────────────────────────────────────────────

model RegTicket {
  id        String   @id @default(cuid())
  tokenHash String   @unique
  email     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([expiresAt])
}

// ─────────────────────────────────────────────────────────────
// ユーザー
// ─────────────────────────────────────────────────────────────

model User {
  id              String    @id @default(cuid())
  firebaseUid     String
  email           String    @unique
  name            String
  namePhonetic    String
  telephoneNumber String
  deletedAt       DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // 企画関連
  ownedProjects    Project[]       @relation("ProjectOwner")
  subOwnedProjects Project[]       @relation("ProjectSubOwner")
  projectMembers   ProjectMember[]

  // 実委人関連
  committeeMember CommitteeMember?

  //Notice関連
  notices                       Notice[]              @relation("NoticeOwner")
  noticeCollaborations          NoticeCollaborator[]
  requestedNoticeAuthorizations NoticeAuthorization[] @relation("NoticeRequestedBy")
  receivedNoticeAuthorizations  NoticeAuthorization[] @relation("NoticeRequestedTo")

  //Form関連
  forms                       Form[]              @relation("FormOwner")
  collaboratingForms          FormCollaborator[]
  requestedFormAuthorizations FormAuthorization[] @relation("FormRequestedBy")
  receivedFormAuthorizations  FormAuthorization[] @relation("FormRequestedTo")
  formResponses               FormResponse[]      @relation("FormRespondent")
  noticeReadStatuses          NoticeReadStatus[]

  userPushSubscriptions UserPushSubscription[]

  // リレーション: ファイル
  files File[]

  // Inquiry関連
  createdInquiries          Inquiry[]         @relation("InquiryCreatedBy")
  inquiryAssignments        InquiryAssignee[] @relation("InquiryAssignee")
  inquiryViewerEntries      InquiryViewer[]   @relation("InquiryViewer")
  inquiryComments           InquiryComment[]  @relation("InquiryCommentCreatedBy")
  inquiryActivitiesAsActor  InquiryActivity[] @relation("InquiryActivityActor")
  inquiryActivitiesAsTarget InquiryActivity[] @relation("InquiryActivityTarget")

  @@unique([firebaseUid, deletedAt])
  @@unique([email, deletedAt])
}

enum ProjectType {
  //ステージ企画
  STAGE

  //食品企画
  FOOD

  //普通企画
  NORMAL
}

model Project {
  id String @id @default(cuid())

  //企画名
  name         String @unique
  namePhonetic String

  //企画団体名
  organizationName         String
  organizationNamePhonetic String

  //企画区分
  type ProjectType

  //責任者
  ownerId String
  owner   User   @relation("ProjectOwner", fields: [ownerId], references: [id])

  //副責任者
  subOwnerId String?
  subOwner   User?   @relation("ProjectSubOwner", fields: [subOwnerId], references: [id])

  //招待コード
  inviteCode String @unique @db.Char(6)

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  projectMembers   ProjectMember[]
  noticeDeliveries NoticeDelivery[]
  formDeliveries   FormDelivery[]
  inquiries        Inquiry[]

  @@index([ownerId])
  @@index([subOwnerId])
  @@index([deletedAt])
}

//プロジェクトに参加している責任者と副責任者以外のユーザーのTable
model ProjectMember {
  id        String @id @default(cuid())
  projectId String
  userId    String

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id])

  joinedAt  DateTime  @default(now())
  deletedAt DateTime?

  @@unique([projectId, userId, deletedAt])
  @@index([projectId])
  @@index([userId])
}

enum Bureau {
  FINANCE // 財務局 (zai)
  GENERAL_AFFAIRS // 総務局 (som)
  PUBLIC_RELATIONS // 広報宣伝局 (kosen)
  EXTERNAL // 渉外局 (sg)
  PROMOTION // 推進局 (ss)
  PLANNING // 総合計画局 (sok)
  STAGE_MANAGEMENT // ステージ管理局 (stage)
  HQ_PLANNING // 本部企画局 (honki)
  INFO_SYSTEM // 情報メディアシステム局 (jsys)
  INFORMATION // 案内所運営部会 (au)
}

//実委人の管理用Table
model CommitteeMember {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  //委員長
  isExecutive Boolean @default(false)

  //所属局
  Bureau Bureau

  joinedAt  DateTime  @default(now())
  deletedAt DateTime?

  permissions CommitteeMemberPermission[]
}

enum CommitteePermission {
  MEMBER_EDIT // メンバー編集
  NOTICE_DELIVER // お知らせ配信
  NOTICE_APPROVE // お知らせ承認
  FORM_DELIVER // フォーム配信
  INQUIRY_ADMIN // お問い合わせ管理
}

//実委人の権限管理Table
model CommitteeMemberPermission {
  id String @id @default(cuid())

  committeeMemberId String
  permission        CommitteePermission

  committeeMember CommitteeMember @relation(fields: [committeeMemberId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([committeeMemberId, permission])
}

// ─────────────────────────────────────────────────────────────
// Push通知
// ─────────────────────────────────────────────────────────────

model PushSubscription {
  id        String    @id @default(cuid())
  endpoint  String    @unique
  p256dh    String
  auth      String
  deletedAt DateTime?
  expiresAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  users UserPushSubscription[]
}

// ─────────────────────────────────────────────────────────────
// User と PushSubscription の中間テーブル
// ─────────────────────────────────────────────────────────────

model UserPushSubscription {
  id                 String @id @default(cuid())
  userId             String
  pushSubscriptionId String

  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  pushSubscription PushSubscription @relation(fields: [pushSubscriptionId], references: [id], onDelete: Cascade)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  @@unique([userId, pushSubscriptionId])
  @@index([userId])
}

// ─────────────────────────────────────────────────────────────
// ファイルストレージ
// ─────────────────────────────────────────────────────────────

enum FileStatus {
  PENDING // URL発行済み、アップロード未確認
  CONFIRMED // アップロード確認済み
}

model File {
  id           String     @id @default(cuid())
  key          String     @unique // S3オブジェクトキー
  fileName     String // 元のファイル名
  mimeType     String
  size         Int // バイト
  isPublic     Boolean    @default(false)
  status       FileStatus @default(PENDING)
  uploadedById String
  uploadedBy   User       @relation(fields: [uploadedById], references: [id])
  deletedAt    DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  noticeAttachments  NoticeAttachment[]
  inquiryAttachments InquiryAttachment[]

  @@index([uploadedById])
  @@index([status])
  @@index([deletedAt])
}

// ─────────────────────────────────────────────────────────────
// お知らせ関連
// ─────────────────────────────────────────────────────────────
//お知らせの作成
model Notice {
  id String @id @default(cuid())

  //お知らせの作成者
  ownerId String
  owner   User   @relation("NoticeOwner", fields: [ownerId], references: [id])

  // 共同編集者
  collaborators NoticeCollaborator[]

  //配信許可など
  authorizations NoticeAuthorization[]

  // 添付ファイル
  attachments NoticeAttachment[]

  //タイトル
  title String @default("無題のお知らせ")

  //本文
  body String?

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

//お知らせの共同編集者
model NoticeCollaborator {
  id String @id @default(cuid())

  noticeId String
  userId   String

  notice Notice @relation(fields: [noticeId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id])

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([noticeId, userId])
}

//Noticeに関する承認待ちの状態Enum
enum NoticeAuthorizationStatus {
  //承認待ち
  PENDING
  //承認済み(時間になれば配信される)
  APPROVED
  //承認されず
  REJECTED
}

//Noticeの配信許可
model NoticeAuthorization {
  id String @id @default(cuid())

  noticeId String
  notice   Notice @relation(fields: [noticeId], references: [id], onDelete: Cascade)

  //承認を求めた人
  requestedById String
  requestedBy   User   @relation("NoticeRequestedBy", fields: [requestedById], references: [id])

  //承認を求められた人
  requestedToId String
  requestedTo   User   @relation("NoticeRequestedTo", fields: [requestedToId], references: [id])

  //審査のステータス
  status NoticeAuthorizationStatus @default(PENDING)

  //審査を行った日付
  decidedAt DateTime?

  //配信したい日時
  //承認を求める側があらかじめここを埋める
  deliveredAt DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  deliveries NoticeDelivery[]

  @@index([noticeId, status])
}

//Noticeの配信
model NoticeDelivery {
  id String @id @default(cuid())

  noticeAuthorizationId String
  projectId             String

  noticeAuthorization NoticeAuthorization @relation(fields: [noticeAuthorizationId], references: [id], onDelete: Cascade)

  //配信先の企画
  project Project @relation(fields: [projectId], references: [id])

  readStatuses NoticeReadStatus[]

  createdAt DateTime @default(now())

  @@unique([noticeAuthorizationId, projectId])
  @@index([projectId])
}

// ─────────────────────────────────────────────────────────────
// フォーム関連
// ─────────────────────────────────────────────────────────────

enum FormItemType {
  //テキスト（短文）
  TEXT

  //テキスト（長文）
  TEXTAREA

  //単一選択
  SELECT

  //複数選択
  CHECKBOX

  //数値
  NUMBER

  //ファイル
  FILE
}

//フォームの作成
model Form {
  id String @id @default(cuid())

  //フォームの作成者
  ownerId String
  owner   User   @relation("FormOwner", fields: [ownerId], references: [id])

  //共同編集者
  collaborators FormCollaborator[]

  //配信許可など
  authorizations FormAuthorization[]

  //タイトル
  title String @default("無題のフォーム")

  //説明
  description String?

  //フォーム項目
  items FormItem[]

  // お問い合わせ関連
  inquiries Inquiry[]

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

//フォームの質問項目
model FormItem {
  id String @id @default(cuid())

  formId String
  form   Form   @relation(fields: [formId], references: [id], onDelete: Cascade)

  //質問文
  label String

  //回答タイプ
  type FormItemType

  //必須かどうか
  required Boolean @default(false)

  //表示順
  sortOrder Int

  //選択肢（select/checkbox用）
  options FormItemOption[]

  //回答
  answers FormAnswer[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([formId])
}

//フォーム項目の選択肢（select/checkbox用）
model FormItemOption {
  id String @id @default(cuid())

  formItemId String
  formItem   FormItem @relation(fields: [formItemId], references: [id], onDelete: Cascade)

  //選択肢のラベル
  label String

  //表示順
  sortOrder Int

  //回答での選択
  selectedIn FormAnswerSelectedOption[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([formItemId])
}

//フォームの共同編集者
model FormCollaborator {
  id String @id @default(cuid())

  formId String
  userId String

  form Form @relation(fields: [formId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id])

  //編集権限を持つのか
  isWrite Boolean @default(false)

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([formId, userId])
}

//Formに関する承認待ちの状態Enum
enum FormAuthorizationStatus {
  //承認待ち
  PENDING
  //承認済み（時間になれば配信される）
  APPROVED
  //承認されず
  REJECTED
}

//フォームの配信許可
model FormAuthorization {
  id String @id @default(cuid())

  formId String
  form   Form   @relation(fields: [formId], references: [id], onDelete: Cascade)

  //承認を求めた人
  requestedById String
  requestedBy   User   @relation("FormRequestedBy", fields: [requestedById], references: [id])

  //承認を求められた人
  requestedToId String
  requestedTo   User   @relation("FormRequestedTo", fields: [requestedToId], references: [id])

  //審査のステータス
  status FormAuthorizationStatus @default(PENDING)

  //審査を行った日付
  decidedAt DateTime?

  //配信したい日時
  scheduledSendAt DateTime

  //回答期限
  deadlineAt DateTime?

  //期限後の回答を許可するか
  allowLateResponse Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  deliveries FormDelivery[]
}

//フォームの配信
model FormDelivery {
  id String @id @default(cuid())

  formAuthorizationId String
  projectId           String

  formAuthorization FormAuthorization @relation(fields: [formAuthorizationId], references: [id], onDelete: Cascade)

  //配信先の企画
  project Project @relation(fields: [projectId], references: [id])

  //回答
  responses FormResponse[]

  createdAt DateTime @default(now())

  @@unique([formAuthorizationId, projectId])
}

//フォームへの回答（1人1回の送信単位）
model FormResponse {
  id String @id @default(cuid())

  formDeliveryId String
  formDelivery   FormDelivery @relation(fields: [formDeliveryId], references: [id], onDelete: Cascade)

  //回答者
  respondentId String
  respondent   User   @relation("FormRespondent", fields: [respondentId], references: [id])

  //各項目への回答
  answers FormAnswer[]

  submittedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([formDeliveryId])
  @@index([respondentId])
}

//各項目への回答（1項目1レコード）
model FormAnswer {
  id String @id @default(cuid())

  formResponseId String
  formResponse   FormResponse @relation(fields: [formResponseId], references: [id], onDelete: Cascade)

  formItemId String
  formItem   FormItem @relation(fields: [formItemId], references: [id])

  //テキスト回答（text, textarea用）
  textValue String?

  //数値回答（number用）
  numberValue Float?

  //ファイルURL（file用）
  fileUrl String?

  //選択肢回答（select, checkbox用）
  selectedOptions FormAnswerSelectedOption[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([formResponseId, formItemId])
  @@index([formResponseId])
  @@index([formItemId])
}

//選択肢の回答（select/checkbox用の中間テーブル）
model FormAnswerSelectedOption {
  id String @id @default(cuid())

  formAnswerId     String
  formItemOptionId String

  formAnswer     FormAnswer     @relation(fields: [formAnswerId], references: [id], onDelete: Cascade)
  formItemOption FormItemOption @relation(fields: [formItemOptionId], references: [id])

  createdAt DateTime @default(now())

  @@unique([formAnswerId, formItemOptionId])
}

//お知らせの既読状態
model NoticeReadStatus {
  id String @id @default(cuid())

  noticeDeliveryId String
  noticeDelivery   NoticeDelivery @relation(fields: [noticeDeliveryId], references: [id], onDelete: Cascade)

  //既読にしたユーザー（企画メンバー）
  userId String
  user   User   @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())

  @@unique([noticeDeliveryId, userId])
}

//お知らせの添付ファイル
model NoticeAttachment {
  id       String @id @default(cuid())
  noticeId String
  fileId   String

  notice Notice @relation(fields: [noticeId], references: [id], onDelete: Cascade)
  file   File   @relation(fields: [fileId], references: [id])

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([noticeId, fileId])
  @@index([fileId])
  @@index([deletedAt])
}

// ─────────────────────────────────────────────────────────────
// お問い合わせ関連
// ─────────────────────────────────────────────────────────────

enum InquiryStatus {
  UNASSIGNED // 担当者未割り当て
  IN_PROGRESS // 対応中
  RESOLVED // 解決済み
}

enum InquiryCreatorRole {
  PROJECT // 企画人
  COMMITTEE // 実委人
}

enum InquiryAssigneeSide {
  PROJECT // 企画側
  COMMITTEE // 実委側
}

enum InquiryViewerScope {
  ALL // 全員
  BUREAU // 特定局
  INDIVIDUAL // 個人
}

enum InquiryActivityType {
  ASSIGNEE_ADDED // 担当者追加
  ASSIGNEE_REMOVED // 担当者削除
  VIEWER_UPDATED // 閲覧者変更
  STATUS_RESOLVED // 解決済みに変更
  STATUS_REOPENED // 再オープン
}

model Inquiry {
  id String @id @default(cuid())

  // 件名
  title String

  // 内容
  body String

  // ステータス
  status InquiryStatus @default(UNASSIGNED)

  // 作成者
  createdById String
  createdBy   User   @relation("InquiryCreatedBy", fields: [createdById], references: [id])

  // 作成者のロール
  creatorRole InquiryCreatorRole

  // 関連する企画
  projectId String
  project   Project @relation(fields: [projectId], references: [id])

  // 関連フォーム（フェーズ 7 で使用）
  relatedFormId String?
  relatedForm   Form?   @relation(fields: [relatedFormId], references: [id])

  assignees   InquiryAssignee[]
  viewers     InquiryViewer[]
  comments    InquiryComment[]
  activities  InquiryActivity[]
  attachments InquiryAttachment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId])
  @@index([status])
}

model InquiryAssignee {
  id String @id @default(cuid())

  inquiryId String
  inquiry   Inquiry @relation(fields: [inquiryId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation("InquiryAssignee", fields: [userId], references: [id])

  // 企画側 or 実委側
  side InquiryAssigneeSide

  // 作成者かどうか（削除不可フラグ）
  isCreator Boolean @default(false)

  assignedAt DateTime @default(now())

  @@unique([inquiryId, userId])
}

model InquiryViewer {
  id String @id @default(cuid())

  inquiryId String
  inquiry   Inquiry @relation(fields: [inquiryId], references: [id], onDelete: Cascade)

  // 閲覧者スコープ
  scope InquiryViewerScope

  // scope = BUREAU の場合の局
  bureauValue Bureau?

  // scope = INDIVIDUAL の場合のユーザー
  userId String?
  user   User?   @relation("InquiryViewer", fields: [userId], references: [id])

  createdAt DateTime @default(now())

  @@index([inquiryId])
  @@index([userId])
}

model InquiryComment {
  id String @id @default(cuid())

  inquiryId String
  inquiry   Inquiry @relation(fields: [inquiryId], references: [id], onDelete: Cascade)

  // コメント内容
  body String

  // 投稿者
  createdById String
  createdBy   User   @relation("InquiryCommentCreatedBy", fields: [createdById], references: [id])

  // 投稿時のロール
  senderRole InquiryCreatorRole @default(PROJECT)

  attachments InquiryAttachment[]

  createdAt DateTime @default(now())

  @@index([inquiryId])
}

model InquiryActivity {
  id String @id @default(cuid())

  inquiryId String
  inquiry   Inquiry @relation(fields: [inquiryId], references: [id], onDelete: Cascade)

  // アクティビティの種類
  type InquiryActivityType

  // 操作者
  actorId String
  actor   User   @relation("InquiryActivityActor", fields: [actorId], references: [id])

  // 対象者（担当者追加・削除時）
  targetId String?
  target   User?   @relation("InquiryActivityTarget", fields: [targetId], references: [id])

  createdAt DateTime @default(now())

  @@index([inquiryId])
}

//お問い合わせの添付ファイル
model InquiryAttachment {
  id        String  @id @default(cuid())
  inquiryId String
  inquiry   Inquiry @relation(fields: [inquiryId], references: [id], onDelete: Cascade)

  // null = 本文の添付、set = コメントの添付
  commentId String?
  comment   InquiryComment? @relation(fields: [commentId], references: [id], onDelete: Cascade)

  fileId String
  file   File   @relation(fields: [fileId], references: [id])

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([inquiryId, fileId])
  @@index([fileId])
  @@index([commentId])
  @@index([deletedAt])
}
