# お知らせ機能 仕様書

## 1. 用語定義

| 用語 | 説明 |
|------|------|
| お知らせ | 実委人が企画向けに配信する情報。承認ワークフローを経て公開される |
| オーナー | お知らせの作成者。編集・削除・共同編集者管理・公開申請が可能 |
| 共同編集者 | オーナーが追加した実委人。編集・添付ファイル管理・公開申請が可能 |
| 承認者 | 公開申請を承認または却下する実委人。`NOTICE_DELIVER` 権限が必要 |
| 公開申請 | お知らせを企画に配信するための承認リクエスト |
| 配信先企画 | お知らせの配信対象となる企画 |
| 既読 | 企画メンバーがお知らせを閲覧済みであること |

---

## 2. 承認ステータス

| ステータス | Enum 値 | 説明 |
|-----------|---------|------|
| 承認待ち | `PENDING` | 承認者の判断を待っている状態 |
| 承認済み | `APPROVED` | 承認され、配信日時到来後に企画へ配信される状態 |
| 却下 | `REJECTED` | 承認者により却下された状態 |

### ステータス遷移

```
PENDING → APPROVED
  操作者: 承認者（requestedTo 本人）
  制約: deliveredAt が未来であること

PENDING → REJECTED
  操作者: 承認者（requestedTo 本人）

PENDING → REJECTED（自動）
  トリガー: お知らせが削除された場合、PENDING の申請は自動的に REJECTED になる
```

---

## 3. ロールと権限

### 3.1 お知らせ配信・承認権限（`NOTICE_DELIVER`）

- `CommitteePermission` の `NOTICE_DELIVER` を使用
- この権限を持つ実委人は公開申請の承認者として指定できる
- 自分自身を承認者として指定することも可能

### 3.2 オーナー

- お知らせの作成者
- 以下の操作が可能:
  - お知らせの編集・削除
  - 共同編集者の追加・削除
  - 添付ファイルの追加・削除
  - 公開申請の送信

### 3.3 共同編集者

- オーナーが追加した実委人
- 以下の操作が可能:
  - お知らせの編集
  - 添付ファイルの追加・削除
  - 公開申請の送信
- 削除はオーナーのみが行える

### 3.4 権限マトリクス

| 操作 | オーナー | 共同編集者 | NOTICE_DELIVER 保持者 | その他の実委人 | 企画メンバー |
|------|---------|-----------|---------------------|-------------|------------|
| お知らせ作成 | - | - | - | o（作成後オーナーになる） | x |
| お知らせ編集 | o | o | x | x | x |
| お知らせ削除 | o | x | x | x | x |
| 共同編集者管理 | o | x | x | x | x |
| 添付ファイル管理 | o | o | x | x | x |
| 公開申請の送信 | o | o | x | x | x |
| 公開申請の承認・却下 | △※1 | △※1 | o（requestedTo 本人のみ） | x | x |
| お知らせ一覧閲覧（実委側） | o | o | o | o | x |
| 配信済みお知らせ閲覧 | - | - | - | - | o（配信先企画のメンバー） |
| 既読にする | - | - | - | - | o |

※1 自分が承認者（requestedTo）として指定されている場合のみ可能

---

## 4. お知らせの作成

任意の実委人がお知らせを作成できる。

| 項目 | 必須 | 説明 |
|------|------|------|
| タイトル | - | テキスト入力 |
| 本文 | - | リッチテキスト（DOMPurify でサニタイズ） |

- 作成者が自動的にオーナーとなる
- 作成直後は下書き状態（公開申請を経て配信される）

---

## 5. 共同編集者

- オーナーが他の実委人を共同編集者として追加できる
- 自分自身は追加できない（既にオーナーであるため）
- ソフトデリート対応: 削除済みの共同編集者を再追加すると再有効化される
- 共同編集者の追加・削除はオーナーのみ可能

---

## 6. 添付ファイル

- お知らせにファイルを添付可能
- ファイルは事前にアップロード API でアップロードし、`fileId` で指定する
- **ファイル所有者チェック**: 添付時に `uploadedById === user.id` を検証
- 添付ファイルの追加・削除はオーナーまたは共同編集者が可能

---

## 7. 公開申請（承認ワークフロー）

### 7.1 申請

オーナーまたは共同編集者が公開申請を送信する。

| 項目 | 必須 | 説明 |
|------|------|------|
| 承認依頼先 | o | `NOTICE_DELIVER` 権限を持つ実委人から選択（自分自身も選択可能） |
| 配信希望日時 | o | 未来の日時を指定 |
| 配信先企画 | o | 企画一覧から1つ以上選択 |

- 同一お知らせに対して PENDING または APPROVED の申請が既に存在する場合は申請不可
- Serializable トランザクションで二重申請を防止

### 7.2 承認・却下

承認者（`requestedTo` 本人）のみが操作可能。

- **承認（APPROVED）**: `deliveredAt` が未来であることを再確認。承認後、配信日時到来時に企画へ配信
- **却下（REJECTED）**: 申請者は内容を修正して再申請可能
- PENDING 状態でなければ操作不可（同時リクエストによる二重承認を防止）

### 7.3 配信

- 承認ステータスが `APPROVED` かつ `deliveredAt` が現在時刻以前のお知らせが企画メンバーに表示される
- 配信先企画ごとに `NoticeDelivery` レコードが作成される

---

## 8. 既読管理

- 企画メンバーが配信済みお知らせを閲覧すると既読にできる
- 冪等操作（既に既読の場合は何もしない）
- `NoticeReadStatus` で企画メンバー単位の既読状態を管理

---

## 9. データモデル

詳細なスキーマは `apps/api/prisma/schema.prisma` を参照。以下は本仕様で重要なモデルと概念のみ記載する。

### モデル一覧

| モデル | 説明 |
|-------|------|
| `Notice` | お知らせ本体。`ownerId`、`title`、`body`、タイムスタンプ、ソフトデリート対応 |
| `NoticeCollaborator` | 共同編集者。`[noticeId, userId]` でユニーク。ソフトデリート対応 |
| `NoticeAuthorization` | 公開申請。`requestedById`（申請者）、`requestedToId`（承認者）、`status`、`deliveredAt` を持つ |
| `NoticeDelivery` | 配信先企画。`NoticeAuthorization` に紐づく |
| `NoticeReadStatus` | 既読状態。`[noticeId, userId]` でユニーク |
| `NoticeAttachment` | 添付ファイル。`fileId` で `File` テーブルを参照 |

### Enum 定義

```prisma
enum NoticeAuthorizationStatus { PENDING, APPROVED, REJECTED }
```

`CommitteePermission` の `NOTICE_DELIVER` がお知らせの配信・承認権限を担う。

---

## 10. API エンドポイント

### 10.1 実委側

ミドルウェア: `requireAuth` → `requireCommitteeMember`

| メソッド | パス | 説明 | 認可 |
|---------|------|------|------|
| POST | `/committee/notices` | お知らせ作成 | 実委人全員 |
| GET | `/committee/notices` | お知らせ一覧 | 実委人全員 |
| GET | `/committee/notices/:noticeId` | お知らせ詳細 | 実委人全員 |
| PATCH | `/committee/notices/:noticeId` | お知らせ編集 | オーナー / 共同編集者 |
| DELETE | `/committee/notices/:noticeId` | お知らせ削除 | オーナーのみ |
| POST | `/committee/notices/:noticeId/collaborators` | 共同編集者追加 | オーナーのみ |
| DELETE | `/committee/notices/:noticeId/collaborators/:collaboratorId` | 共同編集者削除 | オーナーのみ |
| POST | `/committee/notices/:noticeId/attachments` | 添付ファイル追加 | オーナー / 共同編集者 |
| DELETE | `/committee/notices/:noticeId/attachments/:attachmentId` | 添付ファイル削除 | オーナー / 共同編集者 |
| POST | `/committee/notices/:noticeId/authorizations` | 公開申請 | オーナー / 共同編集者 |
| PATCH | `/committee/notices/:noticeId/authorizations/:authorizationId` | 承認 / 却下 | 承認者（`requestedTo` 本人） |

### 10.2 企画側

ミドルウェア: `requireAuth` → `requireProjectMember`

| メソッド | パス | 説明 | 認可 |
|---------|------|------|------|
| GET | `/project/:projectId/notices` | 配信済みお知らせ一覧 | 企画メンバー |
| GET | `/project/:projectId/notices/:noticeId` | お知らせ詳細 | 企画メンバー（配信先企画のみ） |
| POST | `/project/:projectId/notices/:noticeId/read` | 既読にする | 企画メンバー（配信先企画のみ） |

### 10.3 表示条件

企画側に表示されるお知らせは以下の全てを満たすもの:

- 承認ステータスが `APPROVED`
- `deliveredAt`（配信日時）が現在時刻以前
- お知らせが削除されていない（`deletedAt: null`）

---

## 11. UI 仕様

### 11.1 実委側一覧画面

- 全お知らせを一覧表示（実委人全員が閲覧可能）
- 最新の承認申請ステータスを表示
- お知らせの作成ボタン

### 11.2 実委側詳細画面

- メイン: お知らせのタイトル・本文・添付ファイル
- サイドバー:
  - オーナー情報
  - 共同編集者一覧（オーナーのみ追加・削除可能）
  - 承認ステータス（承認者情報、申請日時、判定日時）
  - 公開申請ボタン（オーナー / 共同編集者に表示）
  - 承認・却下ボタン（承認者本人に表示）

### 11.3 公開申請ダイアログ

| 項目 | 説明 |
|------|------|
| 承認依頼先 | `NOTICE_DELIVER` 権限を持つ実委人のドロップダウン（自分自身も含む） |
| 公開日 | 日付ピッカー |
| 公開時刻 | 時刻ピッカー（デフォルト 09:00） |
| 公開先プロジェクト | チェックボックスリスト（検索・全選択機能付き） |

- 送信中はボタンを無効化しローディング表示
- API エラー時はエラーメッセージを表示し、ダイアログは閉じない（フォームデータを保持）

### 11.4 企画側一覧画面

- 配信済みお知らせを一覧表示
- 既読 / 未読ステータスを表示

### 11.5 企画側詳細画面

- お知らせのタイトル・本文・添付ファイルを表示
- 閲覧時に既読 API を呼び出し
