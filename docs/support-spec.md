# お問い合わせ機能 仕様書

## 1. 用語定義

| 用語 | 説明 |
|------|------|
| お問い合わせ | 企画者または実委人が作成する、対応完了まで管理される業務単位 |
| 担当者 | お問い合わせに対応する責任者。企画側・実委側それぞれに複数名設定可能 |
| 閲覧者 | お問い合わせの内容を閲覧できるが、コメントはできない人 |
| お問い合わせ管理者 | 全てのお問い合わせを閲覧・コメントできる実委人ロール |
| 関連フォーム | お問い合わせに関連付けられたフォーム |
| コメント | お問い合わせに対するメッセージ |

---

## 2. 対応状況（ステータス）

| ステータス | 説明 |
|-----------|------|
| 担当者未割り当て | 実委側の担当者がまだ割り当てられていない状態 |
| 対応中 | 担当者が割り当てられ、対応が進行している状態 |
| 解決済み | 対応が完了した状態（閉じた状態） |

### ステータス遷移

```
担当者未割り当て → 対応中（実委側の担当者が割り当てられた時点で自動遷移）
対応中 → 解決済み（実委担当者 or お問い合わせ管理者が操作）
解決済み → 対応中（実委担当者 or お問い合わせ管理者 or 企画担当者が再オープン）
```

---

## 3. ロールと権限

### 3.1 お問い合わせ管理者（新規ロール）

- `CommitteePermission` に `INQUIRY_ADMIN` を追加
- このロールを持つ実委人は全てのお問い合わせに対して以下が可能:
  - 全お問い合わせの閲覧
  - 全お問い合わせへのコメント
  - ステータス変更（対応中 → 解決済み）
  - 閲覧者の編集
  - 担当者の追加・削除

### 3.2 実委側の担当者

- お問い合わせごとに複数名を指定可能
- 当該お問い合わせの閲覧・コメントが可能
- ステータス変更（対応中 → 解決済み）が可能
- 閲覧者の編集が可能
- 担当者の追加・削除が可能
- **作成者は担当者から外れることができない**

### 3.3 企画側の担当者

- お問い合わせごとに複数名を指定可能
- 当該お問い合わせの閲覧・コメントが可能
- 自企画のメンバーを共同担当者として追加・削除できる
- 解決済みのお問い合わせを再オープンできる
- **作成者（企画人が作成した場合）は担当者から外れることができない**

### 3.4 閲覧者（新規概念）

お問い合わせごとに閲覧範囲を設定できる。コメントはできない。

#### 閲覧者スコープ

| スコープ | 説明 |
|---------|------|
| 全員 | 全ての実委人が閲覧可能 |
| 特定局 | 指定された局（Bureau）に所属する実委人が閲覧可能。複数局指定可 |
| 個人 | 指定された個人の実委人が閲覧可能。複数名指定可 |

- 複数スコープの組み合わせが可能（例: 総務局 + 個人3名）
- 閲覧者の編集は、お問い合わせ管理者および担当者が行える

### 3.5 権限マトリクス

| 操作 | 企画担当者 | 実委担当者 | お問い合わせ管理者 | 閲覧者 | その他 |
|------|-----------|-----------|------------------|--------|--------|
| 閲覧 | o | o | o | o | x |
| コメント | o | o | o | x | x |
| ステータス → 解決済み | x | o | o | x | x |
| 再オープン | o | o | o | x | x |
| 企画側担当者の追加・削除 | △※1 | o | o | x | x |
| 実委側担当者の追加・削除 | x | o | o | x | x |
| 閲覧者の編集 | x | o | o | x | x |

※1 自企画のメンバーに限り追加・削除が可能

---

## 4. お問い合わせの作成

### 4.1 企画人による作成

| 項目 | 必須 | 説明 |
|------|------|------|
| 件名 | o | テキスト入力 |
| 内容 | o | テキストエリア |
| 関連フォーム | - | 自企画に配信されたフォームから選択 |

- 作成者は自動的に企画側の担当者となる
- 共同担当者として自企画のメンバーを追加可能
- 企画人は実委側の担当者を設定できない（初期対応ルールまたは実委側で割り当て）

### 4.2 実委人による作成

任意の実委人がお問い合わせを作成できる。

| 項目 | 必須 | 説明 |
|------|------|------|
| 件名 | o | テキスト入力 |
| 内容 | o | テキストエリア |
| 関連フォーム | - | フォーム一覧から選択 |
| 企画側の担当者 | o | 対象企画のメンバーから選択（複数可） |
| 実委側の追加担当者 | - | 実委人から選択（複数可） |

- 作成者は自動的に実委側の担当者となる

---

## 5. 初期対応ルール

### 5.1 フォームに関連するお問い合わせ

| 対象 | 初期割り当て |
|------|------------|
| フォームオーナー | 実委側の初期担当者 |
| フォームの共同編集者 | 初期の閲覧者（個人スコープ） |

- 企画人が関連フォームを選択してお問い合わせを作成した場合に適用
- 初期割り当て後、担当者・閲覧者の変更は可能

### 5.2 フォームに関連しないお問い合わせ

- ステータスは「担当者未割り当て」となる
- お問い合わせ管理者が適切に担当者と閲覧者を割り当てる

---

## 6. コメント

- 企画側の担当者と実委側の担当者、お問い合わせ管理者がコメントを追加できる
- 閲覧者はコメントできない
- 解決済み（閉じた）のお問い合わせにはコメントできない
- コメントには投稿者の情報（名前・所属・ロール）と投稿日時が表示される

---

## 7. データモデル

### 7.1 Inquiry（お問い合わせ）

| カラム | 型 | 説明 |
|-------|-----|------|
| id | String | PK |
| title | String | 件名 |
| body | String | 内容 |
| status | InquiryStatus | 担当者未割り当て / 対応中 / 解決済み |
| createdById | String | 作成者の User ID |
| creatorRole | InquiryCreatorRole | project / committee |
| projectId | String | 関連する企画の ID |
| relatedFormId | String? | 関連フォームの ID（任意） |
| createdAt | DateTime | 作成日時 |
| updatedAt | DateTime | 更新日時 |

### 7.2 InquiryAssignee（担当者）

| カラム | 型 | 説明 |
|-------|-----|------|
| id | String | PK |
| inquiryId | String | お問い合わせ ID |
| userId | String | 担当者の User ID |
| side | InquiryAssigneeSide | project / committee |
| isCreator | Boolean | 作成者かどうか（削除不可フラグ） |
| assignedAt | DateTime | 割り当て日時 |

### 7.3 InquiryViewer（閲覧者）

| カラム | 型 | 説明 |
|-------|-----|------|
| id | String | PK |
| inquiryId | String | お問い合わせ ID |
| scope | InquiryViewerScope | all / bureau / individual |
| bureauValue | Bureau? | scope が bureau の場合の局 |
| userId | String? | scope が individual の場合の User ID |

### 7.4 InquiryComment（コメント）

| カラム | 型 | 説明 |
|-------|-----|------|
| id | String | PK |
| inquiryId | String | お問い合わせ ID |
| body | String | コメント内容 |
| createdById | String | 投稿者の User ID |
| createdAt | DateTime | 投稿日時 |

### 7.5 InquiryActivity（アクティビティログ）

| カラム | 型 | 説明 |
|-------|-----|------|
| id | String | PK |
| inquiryId | String | お問い合わせ ID |
| type | InquiryActivityType | アクティビティの種類 |
| actorId | String | 操作者の User ID |
| targetId | String? | 対象者の User ID |
| createdAt | DateTime | 発生日時 |

### 7.6 Enum 定義

```
enum InquiryStatus {
  UNASSIGNED    // 担当者未割り当て
  IN_PROGRESS   // 対応中
  RESOLVED      // 解決済み
}

enum InquiryCreatorRole {
  PROJECT       // 企画人
  COMMITTEE     // 実委人
}

enum InquiryAssigneeSide {
  PROJECT       // 企画側
  COMMITTEE     // 実委側
}

enum InquiryViewerScope {
  ALL           // 全員
  BUREAU        // 特定局
  INDIVIDUAL    // 個人
}

enum InquiryActivityType {
  ASSIGNEE_ADDED       // 担当者追加
  ASSIGNEE_REMOVED     // 担当者削除
  VIEWER_UPDATED       // 閲覧者変更
  STATUS_RESOLVED      // 解決済みに変更
  STATUS_REOPENED      // 再オープン
}
```

### 7.7 CommitteePermission への追加

```
enum CommitteePermission {
  MEMBER_EDIT
  NOTICE_DELIVER
  NOTICE_APPROVE
  FORM_DELIVER
  INQUIRY_ADMIN     // 新規追加: お問い合わせ管理者
}
```

---

## 8. API エンドポイント

### 8.1 企画側

| メソッド | パス | 説明 | 認可 |
|---------|------|------|------|
| GET | `/project/:projectId/inquiries` | 自分が担当のお問い合わせ一覧 | 企画メンバー |
| GET | `/project/:projectId/inquiries/:inquiryId` | お問い合わせ詳細 | 企画側担当者 |
| POST | `/project/:projectId/inquiries` | お問い合わせ作成 | 企画メンバー |
| POST | `/project/:projectId/inquiries/:inquiryId/comments` | コメント追加 | 企画側担当者 |
| PATCH | `/project/:projectId/inquiries/:inquiryId/reopen` | 再オープン | 企画側担当者 |
| POST | `/project/:projectId/inquiries/:inquiryId/assignees` | 共同担当者追加 | 企画側担当者（自企画メンバーのみ） |
| DELETE | `/project/:projectId/inquiries/:inquiryId/assignees/:assigneeId` | 共同担当者削除 | 企画側担当者 |

### 8.2 実委側

| メソッド | パス | 説明 | 認可 |
|---------|------|------|------|
| GET | `/committee/inquiries` | お問い合わせ一覧 | 担当者 / 閲覧者 / 管理者 |
| GET | `/committee/inquiries/:inquiryId` | お問い合わせ詳細 | 担当者 / 閲覧者 / 管理者 |
| POST | `/committee/inquiries` | お問い合わせ作成 | 実委人 |
| POST | `/committee/inquiries/:inquiryId/comments` | コメント追加 | 担当者 / 管理者 |
| PATCH | `/committee/inquiries/:inquiryId/status` | ステータス変更 | 担当者 / 管理者 |
| PATCH | `/committee/inquiries/:inquiryId/reopen` | 再オープン | 担当者 / 管理者 |
| POST | `/committee/inquiries/:inquiryId/assignees` | 担当者追加 | 担当者 / 管理者 |
| DELETE | `/committee/inquiries/:inquiryId/assignees/:assigneeId` | 担当者削除 | 担当者 / 管理者 |
| PUT | `/committee/inquiries/:inquiryId/viewers` | 閲覧者設定 | 担当者 / 管理者 |

---

## 9. 閲覧権限の判定ロジック

実委人がお問い合わせを閲覧できるかの判定:

```
1. INQUIRY_ADMIN 権限を持っている → 閲覧可能
2. 実委側の担当者である → 閲覧可能
3. 閲覧者に含まれる:
   a. scope = ALL の閲覧者レコードが存在 → 閲覧可能
   b. scope = BUREAU かつ自分の所属局と一致 → 閲覧可能
   c. scope = INDIVIDUAL かつ自分の userId と一致 → 閲覧可能
4. 上記いずれにも該当しない → 閲覧不可
```

---

## 10. UI 仕様

基本的に現在のモック実装に準拠する。以下に主要な変更点を記載する。

### 10.1 ステータス表示

| ステータス | 色 | アイコン |
|-----------|-----|---------|
| 担当者未割り当て | オレンジ | 警告アイコン |
| 対応中 | 青 | 進行中アイコン |
| 解決済み | 緑 | チェックアイコン |

### 10.2 実委側一覧画面

タブ + セクション構成:

**タブ「未完了」** (デフォルト):
- セクション「自分の担当」 - 自分が実委側担当者の対応中お問い合わせ
- セクション「担当者未割り当て」 - INQUIRY_ADMIN のみ表示。強調表示
- セクション「閲覧中」 - 閲覧者として見えるもの（対応中のみ）

**タブ「解決済み」**:
- 自分がアクセス可能な解決済みお問い合わせを一覧

共通:
- 検索機能
- 各セクション内のお問い合わせが0件の場合はセクション非表示

### 10.3 企画側一覧画面

- 自分が担当者のお問い合わせのみ表示
- 「対応中」「解決済み」で分類
- 検索機能

### 10.4 詳細画面

- サイドバー: ステータス、担当者一覧、閲覧者設定、関連フォーム
- メイン: タイムライン（コメント + アクティビティ）
- 解決済みの場合、コメント入力欄は非活性（再オープンボタンを表示）
- 閲覧者設定セクション（実委側のみ）: スコープごとの設定 UI

### 10.5 新規作成ダイアログ

- 企画側: 件名、内容、関連フォーム、共同担当者
- 実委側: 件名、内容、関連フォーム、企画側担当者（必須）、追加実委担当者

---

## 11. モックからの主な変更点

| 項目 | モック | 本番 |
|------|--------|------|
| ステータス | 新規 / 対応中 / 解決済み | 担当者未割り当て / 対応中 / 解決済み |
| 閲覧制御 | なし（全件表示） | 担当者・閲覧者・管理者のみ |
| 閲覧者 | なし | 全員 / 特定局 / 個人スコープで設定可能 |
| お問い合わせ管理者 | なし | INQUIRY_ADMIN 権限で全件アクセス |
| 初期担当者 | なし | フォームオーナーを自動割り当て |
| 初期閲覧者 | なし | フォーム共同編集者を自動割り当て |
| 作成者保護 | なし | 作成者は担当者から削除不可 |
| データ永続化 | インメモリ | PostgreSQL + Prisma |
