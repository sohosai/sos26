# お問い合わせ機能 仕様書

## 1. 用語定義

| 用語 | 説明 |
|------|------|
| お問い合わせ | 企画者または実委人が作成する、対応完了まで管理される業務単位 |
| 担当者 | お問い合わせに対応する責任者。企画側・実委側それぞれに複数名設定可能 |
| 閲覧者 | お問い合わせの内容を閲覧できるが、コメントはできない実委人 |
| お問い合わせ管理者 | 全てのお問い合わせを閲覧・コメントできる実委人ロール（`INQUIRY_ADMIN`） |
| 関連フォーム | お問い合わせに関連付けられたフォーム |
| コメント | お問い合わせに対するメッセージ。ファイル添付可能 |

---

## 2. 対応状況（ステータス）

| ステータス | Enum 値 | 説明 |
|-----------|---------|------|
| 担当者未割り当て | `UNASSIGNED` | 実委側の担当者がまだ割り当てられていない状態 |
| 対応中 | `IN_PROGRESS` | 実委側の担当者が割り当てられ、対応が進行している状態 |
| 解決済み | `RESOLVED` | 対応が完了した状態（閉じた状態） |

### ステータス遷移

```
担当者未割り当て → 対応中
  トリガー: 実委側の担当者が割り当てられた時点で自動遷移

対応中 → 担当者未割り当て
  トリガー: 最後の実委側担当者が削除された時点で自動遷移

対応中 → 解決済み
  操作者: 実委担当者 or お問い合わせ管理者
  制約: 対応中（IN_PROGRESS）からのみ遷移可能

解決済み → 対応中 or 担当者未割り当て
  操作者: 実委担当者 or お問い合わせ管理者 or 企画担当者
  ロジック: 実委側担当者が存在すれば「対応中」、存在しなければ「担当者未割り当て」に遷移
```

---

## 3. ロールと権限

### 3.1 お問い合わせ管理者

- `CommitteePermission` に `INQUIRY_ADMIN` を追加
- このロールを持つ実委人は全てのお問い合わせに対して以下が可能:
  - 全お問い合わせの閲覧
  - 全お問い合わせへのコメント
  - ステータス変更（対応中 → 解決済み）
  - 閲覧者の編集
  - 担当者の追加・削除

### 3.2 実委側の担当者

- お問い合わせごとに複数名を指定可能
- 当該お問い合わせの閲覧・コメントが可能
- ステータス変更（対応中 → 解決済み）が可能
- 閲覧者の編集が可能
- 担当者の追加・削除が可能
- **作成者は担当者から外れることができない**

### 3.3 企画側の担当者

- お問い合わせごとに複数名を指定可能
- 当該お問い合わせの閲覧・コメントが可能
- 自企画のメンバーを共同担当者として追加・削除できる
- **企画側の担当者のみ削除可能**（実委側の担当者は削除不可）
- 解決済みのお問い合わせを再オープンできる
- **作成者（企画人が作成した場合）は担当者から外れることができない**
- 企画側には「閲覧者」の概念はない。担当者以外の企画メンバーはお問い合わせにアクセスできない

### 3.4 閲覧者（実委側のみ）

お問い合わせごとに閲覧範囲を設定できる。コメントはできない。

#### 閲覧者スコープ

| スコープ | Enum 値 | 説明 |
|---------|---------|------|
| 全員 | `ALL` | 全ての実委人が閲覧可能 |
| 特定局 | `BUREAU` | 指定された局（Bureau）に所属する実委人が閲覧可能。複数局指定可 |
| 個人 | `INDIVIDUAL` | 指定された個人の実委人が閲覧可能。複数名指定可 |

- 複数スコープの組み合わせが可能（例: 総務局 + 個人3名）
- 閲覧者の編集は、お問い合わせ管理者および実委側担当者が行える
- 閲覧者設定の更新は既存レコードを全削除して再作成（PUT セマンティクス）

### 3.5 権限マトリクス

| 操作 | 企画担当者 | 実委担当者 | お問い合わせ管理者 | 閲覧者 | その他 |
|------|-----------|-----------|------------------|--------|--------|
| 閲覧 | o | o | o | o | x |
| コメント | o | o | o | x | x |
| ステータス → 解決済み | x | o | o | x | x |
| 再オープン | o | o | o | x | x |
| 企画側担当者の追加・削除 | △※1 | o | o | x | x |
| 実委側担当者の追加・削除 | x | o | o | x | x |
| 閲覧者の編集 | x | o | o | △※2 | x |

※1 自企画のメンバーに限り追加・削除が可能
※2 閲覧者は閲覧者設定を閲覧できるが、編集はできない

---

## 4. お問い合わせの作成

### 4.1 企画人による作成

| 項目 | 必須 | 説明 |
|------|------|------|
| 件名 | o | テキスト入力 |
| 内容 | o | テキストエリア |
| 関連フォーム | - | 自企画に配信されたフォームから選択（**未実装**） |
| 共同担当者 | - | 自企画のメンバーから選択（複数可） |
| 添付ファイル | - | ファイルアップロード（複数可） |

- 作成者は自動的に企画側の担当者（`isCreator: true`）となる
- 共同担当者として自企画のメンバーを追加可能
- 企画人は実委側の担当者を設定できない
- 初期ステータスは `UNASSIGNED`（関連フォームによる初期割り当てが行われた場合は `IN_PROGRESS`、5章参照）

### 4.2 実委人による作成

任意の実委人がお問い合わせを作成できる。

| 項目 | 必須 | 説明 |
|------|------|------|
| 件名 | o | テキスト入力 |
| 内容 | o | テキストエリア |
| 関連フォーム | - | フォーム一覧から選択（**未実装**） |
| 対象企画 | o | 企画一覧から選択 |
| 企画側の担当者 | o | 対象企画のメンバーから選択（複数可） |
| 実委側の追加担当者 | - | 実委人から選択（複数可） |
| 閲覧者 | - | 作成時に設定可能 |
| 添付ファイル | - | ファイルアップロード（複数可） |

- 作成者は自動的に実委側の担当者（`isCreator: true`）となる
- 実委側担当者が必ず存在するため、初期ステータスは `IN_PROGRESS`

---

## 5. 初期対応ルール

> **未実装**: フォーム機能の完成が前提。DB スキーマに `relatedFormId` カラムは定義済み。

### 5.1 フォームに関連するお問い合わせ

企画人が関連フォームを選択してお問い合わせを作成した場合:

| 対象 | 初期割り当て |
|------|------------|
| フォームオーナー | 実委側の初期担当者 → ステータスを `IN_PROGRESS` に |
| フォームの共同編集者 | 初期の閲覧者（個人スコープ） |

- 初期割り当て後、担当者・閲覧者の変更は可能

### 5.2 フォームに関連しないお問い合わせ

- ステータスは `UNASSIGNED` となる
- お問い合わせ管理者が適切に担当者と閲覧者を割り当てる

---

## 6. コメント

- 企画側の担当者と実委側の担当者、お問い合わせ管理者がコメントを追加できる
- 閲覧者はコメントできない
- 解決済みのお問い合わせにはコメントできない
- コメントには投稿者の情報（名前・ロール）と投稿日時が表示される
- コメントにはファイルを添付可能
- コメント投稿時に `senderRole`（`PROJECT` or `COMMITTEE`）が記録される
- コメント追加時にお問い合わせの `updatedAt` が更新される

---

## 7. ファイル添付

- お問い合わせ本文とコメントにファイルを添付可能
- ファイルは事前にアップロード API でアップロードし、`fileId` で指定する
- **ファイル所有者チェック**: 添付時に `uploadedById === user.id` を検証し、自分がアップロードしたファイルのみ添付可能
- ファイルアクセス権限: お問い合わせの閲覧権限（担当者 / 管理者 / 閲覧者）に基づいてファイルへのアクセスを制御

---

## 8. データモデル

詳細なスキーマは `apps/api/prisma/schema.prisma` を参照。以下は本仕様で重要なモデルと概念のみ記載する。

### モデル一覧

| モデル | 説明 |
|-------|------|
| `Inquiry` | お問い合わせ本体 |
| `InquiryAssignee` | 担当者。`side`（PROJECT / COMMITTEE）と `isCreator`（削除不可フラグ）を持つ。`[inquiryId, userId]` でユニーク |
| `InquiryViewer` | 閲覧者。`scope`（ALL / BUREAU / INDIVIDUAL）に応じて `bureauValue` または `userId` を持つ |
| `InquiryComment` | コメント。`senderRole` で投稿時のロールを記録 |
| `InquiryAttachment` | 添付ファイル。`commentId` が null なら本文添付、set ならコメント添付 |
| `InquiryActivity` | アクティビティログ。`type` で種類、`targetId` で対象者を記録 |

### Enum 定義

```prisma
enum InquiryStatus       { UNASSIGNED, IN_PROGRESS, RESOLVED }
enum InquiryCreatorRole  { PROJECT, COMMITTEE }
enum InquiryAssigneeSide { PROJECT, COMMITTEE }
enum InquiryViewerScope  { ALL, BUREAU, INDIVIDUAL }
enum InquiryActivityType { ASSIGNEE_ADDED, ASSIGNEE_REMOVED, VIEWER_UPDATED, STATUS_RESOLVED, STATUS_REOPENED }
```

`CommitteePermission` に `INQUIRY_ADMIN` を追加。

---

## 9. API エンドポイント

### 9.1 企画側

ミドルウェア: `requireAuth` → `requireProjectMember`

| メソッド | パス | 説明 | 認可 |
|---------|------|------|------|
| GET | `/project/:projectId/inquiries` | 自分が担当のお問い合わせ一覧 | 企画メンバー |
| GET | `/project/:projectId/inquiries/:inquiryId` | お問い合わせ詳細 | 企画側担当者 |
| POST | `/project/:projectId/inquiries` | お問い合わせ作成 | 企画メンバー |
| POST | `/project/:projectId/inquiries/:inquiryId/comments` | コメント追加 | 企画側担当者 |
| PATCH | `/project/:projectId/inquiries/:inquiryId/reopen` | 再オープン | 企画側担当者 |
| POST | `/project/:projectId/inquiries/:inquiryId/assignees` | 共同担当者追加 | 企画側担当者（自企画メンバーのみ） |
| DELETE | `/project/:projectId/inquiries/:inquiryId/assignees/:assigneeId` | 共同担当者削除 | 企画側担当者（企画側担当者のみ削除可） |

### 9.2 実委側

ミドルウェア: `requireAuth` → `requireCommitteeMember`

| メソッド | パス | 説明 | 認可 |
|---------|------|------|------|
| GET | `/committee/inquiries` | お問い合わせ一覧 | 担当者 / 閲覧者 / 管理者 |
| GET | `/committee/inquiries/:inquiryId` | お問い合わせ詳細 | 担当者 / 閲覧者 / 管理者 |
| POST | `/committee/inquiries` | お問い合わせ作成 | 実委人 |
| POST | `/committee/inquiries/:inquiryId/comments` | コメント追加 | 担当者 / 管理者 |
| PATCH | `/committee/inquiries/:inquiryId/status` | ステータス変更（解決済みに） | 担当者 / 管理者 |
| PATCH | `/committee/inquiries/:inquiryId/reopen` | 再オープン | 担当者 / 管理者 |
| POST | `/committee/inquiries/:inquiryId/assignees` | 担当者追加 | 担当者 / 管理者 |
| DELETE | `/committee/inquiries/:inquiryId/assignees/:assigneeId` | 担当者削除 | 担当者 / 管理者 |
| PUT | `/committee/inquiries/:inquiryId/viewers` | 閲覧者設定 | 担当者 / 管理者 |

### 9.3 自動ステータス遷移

API 内で以下の自動遷移が行われる:

| 操作 | 条件 | 遷移 |
|------|------|------|
| 実委側担当者の追加 | ステータスが `UNASSIGNED` | `UNASSIGNED` → `IN_PROGRESS` |
| 実委側担当者の削除 | 実委側担当者が0人になり、ステータスが `IN_PROGRESS` | `IN_PROGRESS` → `UNASSIGNED` |
| 再オープン | 実委側担当者が存在 | `RESOLVED` → `IN_PROGRESS` |
| 再オープン | 実委側担当者が不在 | `RESOLVED` → `UNASSIGNED` |

---

## 10. 閲覧権限の判定ロジック

### 10.1 実委人の閲覧権限

```
1. INQUIRY_ADMIN 権限を持っている → 閲覧可能
2. 実委側の担当者である → 閲覧可能
3. 閲覧者に含まれる:
   a. scope = ALL の閲覧者レコードが存在 → 閲覧可能
   b. scope = BUREAU かつ自分の所属局と一致 → 閲覧可能
   c. scope = INDIVIDUAL かつ自分の userId と一致 → 閲覧可能
4. 上記いずれにも該当しない → 閲覧不可
```

### 10.2 企画人の閲覧権限

- 企画側担当者であればアクセス可能
- 担当者以外の企画メンバーはアクセス不可（閲覧者の概念なし）

### 10.3 添付ファイルのアクセス権限

`InquiryAttachment` 経由でファイルの所属するお問い合わせを特定し、上記 10.1 / 10.2 の閲覧権限に基づいてアクセスを制御する。

### 10.4 実委側一覧の DB フィルタリング

実委側一覧 API（`GET /committee/inquiries`）は DB クエリで権限に基づくフィルタリングを行う:

- **管理者（INQUIRY_ADMIN）**: 全件取得
- **それ以外**: 以下の OR 条件でフィルタリング
  - 実委側担当者として割り当てられている
  - 閲覧者スコープに一致する（ALL / BUREAU + 所属局 / INDIVIDUAL + userId）

---

## 11. UI 仕様

### 11.1 ステータス表示

| ステータス | 色 | アイコン |
|-----------|-----|---------|
| 担当者未割り当て | オレンジ | 警告アイコン |
| 対応中 | 青 | 進行中アイコン |
| 解決済み | 緑 | チェックアイコン |

### 11.2 実委側一覧画面

タブ + セクション構成:

**タブ「未完了」** (デフォルト):
- セクション「自分の担当」 - 自分が実委側担当者の対応中お問い合わせ
- セクション「担当者未割り当て」 - INQUIRY_ADMIN のみ表示。強調表示
- セクション「閲覧中」 - 閲覧者として見えるもの（対応中のみ）

**タブ「解決済み」**:
- 自分がアクセス可能な解決済みお問い合わせを一覧

共通:
- 検索機能
- 各セクション内のお問い合わせが0件の場合はセクション非表示

### 11.3 企画側一覧画面

- 自分が担当者のお問い合わせのみ表示
- 「対応中」「解決済み」で分類
- 検索機能

### 11.4 詳細画面

- サイドバー: ステータス、担当者一覧、閲覧者設定（実委側のみ）、関連フォーム（**未実装**）
- メイン: タイムライン（コメント + アクティビティ）
- 解決済みの場合、コメント入力欄は非活性（再オープンボタンを表示）
- 閲覧者設定セクション（実委側のみ）: スコープごとの設定 UI
- 自分を担当者から外す際は確認ダイアログを表示

### 11.5 新規作成ダイアログ

- 企画側: 件名、内容、関連フォーム（**未実装**）、共同担当者、添付ファイル
- 実委側: 件名、内容、関連フォーム（**未実装**）、対象企画、企画側担当者（必須）、追加実委担当者、閲覧者、添付ファイル
- 送信中はボタンを無効化しローディング表示
- API エラー時はトースト通知を表示し、ダイアログは閉じない（フォームデータを保持）

---

## 12. 未実装項目

### フォーム紐づけ

> **前提**: フォーム機能が完成していること。DB スキーマに `relatedFormId` カラムは定義済み。

- 作成フォームに関連フォーム選択 UI を追加（4章参照）
- 初期対応ルールの実装（5章参照）
- 詳細画面に関連フォームのリンク表示（11.4 参照）
- 作成リクエストスキーマに `relatedFormId` を追加、レスポンスに関連フォーム情報を含める
